<canvas id="canv" width="220" height="420"></canvas>

<script>
const height = 22 // total height
const visibleHeight = 20
const width = 10
const squareSize = 20
const bx1 = 10.5
const by1 = 10.5
const origFallCooldown = 30 // ticks

var canv, ctx, activePiece, field, requestID, gameOver

// 0 1 2 3
// 4 5 6 7

window.onload=function() {
	canv = document.getElementById("canv")
	ctx = canv.getContext("2d")
	document.addEventListener("keydown", keyPush)
	requestID = window.requestAnimationFrame(loop)

	init()
}

function init() {
	activePiece = {active: false}

	field = []
	for (var i = 0; i < height * width; i++) {
		field[i] = false
	}

	gameOver = false
}

function drawField() {
	ctx.rect(bx1, by1, width * squareSize, visibleHeight * squareSize)
	ctx.stroke()

	for (let i = 20; i < field.length; i++) {
		let {x, y} = indexToCoor(i)
		if (field[i]) {
			ctx.fillRect(bx1 + x * squareSize, by1 + y * squareSize, squareSize, squareSize)
		}
	}
}

function indexToCoor(i) {
	let x = i % width
	let y = Math.floor(i / width) - height + visibleHeight
	return {x, y}
}

function coorToIndex(obj) {
	return (obj.y - visibleHeight + height) * width + obj.x
}


function loop(timestamp) {
	update()
	draw()
	if (!gameOver) {
		requestID = window.requestAnimationFrame(loop)
	}
}

function draw() {
	ctx.clearRect(0, 0, canv.width, canv.height)
	drawField()
}

function update() {
	if (!activePiece.active) {
		spawnPiece()
		if (!validPieceLocation()) {
			console.log('Game Over');
			gameOver = true
			return
		}
		addPiece()
		fallCooldown = origFallCooldown
	} else {
		fallCooldown -= 1
	}

	if (fallCooldown <= 0) {
		let willClear = false
		removePiece()
		activePiece.y += 1
		if (!validPieceLocation()) {
			activePiece.y -= 1
			activePiece.active = false
			willClear = true
		}
		addPiece()
		if (willClear) {
			checkClear()
		}
		fallCooldown = origFallCooldown
	}

}

function checkClear() {
	for (var i = 0; i < height; i++) {
		let clear = true
		for (var col = 0; col < width; col++) {
			let index = i*width + col
			if (!field[index]) {
				clear = false
				break
			}
		}

		if (clear) {
			for (row = i; row > 0; row--) {
				for (var col = 0; col < width; col++) {
					const index1 = row*width + col
					const index2 = (row-1)*width + col
					field[index1] = field[index2]
				}
			}
			for (var col = 0; col < width; col++) {
				field[col] = false
			}
		}
	}
}

function canFall() {
	return activePiece.y < visibleHeight
}

function removePiece() {
	handlePiece(false)
}

function addPiece() {
	handlePiece(true)
}

function validPieceLocation() {
	var i = coorToIndex(activePiece)

	switch (activePiece.id) {
		case 'O':
			return activePiece.x-1 >= 0 &&
				activePiece.x < width &&
				activePiece.y+1 < visibleHeight &&
				!(field[i] || field[i-1] || field[i-1+width] || field[i+width])
			break;
		case 'L':
			if (activePiece.rotation % 4 == 0) {
				return activePiece.x-1 >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+1] || field[i-1] || field[i-1+width])
			} else if (activePiece.rotation % 4 == 1) {
				return activePiece.x-1 >= 0 &&
					activePiece.x < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+width] || field[i-width] || field[i-1-width])
			} else if (activePiece.rotation % 4 == 2) {
				return activePiece.x-1 >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y < visibleHeight &&
					!(field[i] || field[i+1] || field[i-1] || field[i+1-width])
			} else if (activePiece.rotation % 4 == 3) {
				return activePiece.x >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+width] || field[i-width] || field[i+1+width])
			}
			break;
		case 'J':
			if (activePiece.rotation % 4 == 0) {
				return activePiece.x-1 >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+1] || field[i-1] || field[i+1+width])
			} else if (activePiece.rotation % 4 == 1) {
				return activePiece.x-1 >= 0 &&
					activePiece.x < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+width] || field[i-width] || field[i-1+width])
			} else if (activePiece.rotation % 4 == 2) {
				return activePiece.x-1 >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y < visibleHeight &&
					!(field[i] || field[i+1] || field[i-1] || field[i+1-width])
			} else if (activePiece.rotation % 4 == 3) {
				return activePiece.x >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+width] || field[i-width] || field[i+1-width])
			}
			break;
		case 'Z':
			if (activePiece.rotation % 2 == 0) {
				return activePiece.x-1 >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i-1] || field[i+width] || field[i+1+width])
			} else if (activePiece.rotation % 2 == 1) {
				return activePiece.x >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+width] || field[i+1] || field[i+1-width])
			}
			break;
		case 'S':
			if (activePiece.rotation % 2 == 0) {
				return activePiece.x-1 >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+1] || field[i-1+width] || field[i+width])
			} else if (activePiece.rotation % 2 == 1) {
				return activePiece.x >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i-width] || field[i+1] || field[i+1+width])
			}
			break;
		case 'I':
			if (activePiece.rotation % 2 == 0) {
				return activePiece.x-2 >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y < visibleHeight &&
					!(field[i] || field[i+1] || field[i-1] || field[i-2])
			} else if (activePiece.rotation % 2 == 1) {
				return activePiece.x >= 0 &&
					activePiece.x < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+width] || field[i-width] || field[i-2*width])
			}
			break;
		case 'T':
			if (activePiece.rotation % 4 == 0) {
				return activePiece.x-1 >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+1] || field[i-1] || field[i+width])
			} else if (activePiece.rotation % 4 == 1) {
				return activePiece.x-1 >= 0 &&
					activePiece.x < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i-1] || field[i-width] || field[i+width])
			} else if (activePiece.rotation % 4 == 2) {
				return activePiece.x-1 >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y < visibleHeight &&
					!(field[i] || field[i+1] || field[i-1] || field[i-width])
			} else if (activePiece.rotation % 4 == 3) {
				return activePiece.x >= 0 &&
					activePiece.x+1 < width &&
					activePiece.y+1 < visibleHeight &&
					!(field[i] || field[i+1] || field[i-width] || field[i+width])
			}
			break;
		default:
	}
}

function handlePiece(setTo) {
	var i = coorToIndex(activePiece)
	switch (activePiece.id) {
		case 'O':
			field[i] = setTo
			field[i-1] = setTo
			field[i-1+width] = setTo
			field[i+width] = setTo
			break;
		case 'L':
			if (activePiece.rotation % 4 == 0) {
				field[i] = setTo
				field[i+1] = setTo
				field[i-1] = setTo
				field[i-1+width] = setTo
			} else if (activePiece.rotation % 4 == 1) {
				field[i] = setTo
				field[i+width] = setTo
				field[i-width] = setTo
				field[i-1-width] = setTo
			} else if (activePiece.rotation % 4 == 2) {
				field[i] = setTo
				field[i+1] = setTo
				field[i-1] = setTo
				field[i+1-width] = setTo
			} else if (activePiece.rotation % 4 == 3) {
				field[i] = setTo
				field[i+width] = setTo
				field[i-width] = setTo
				field[i+1+width] = setTo
			}
			break;
		case 'J':
			if (activePiece.rotation % 4 == 0) {
				field[i] = setTo
				field[i+1] = setTo
				field[i-1] = setTo
				field[i+1+width] = setTo
			} else if (activePiece.rotation % 4 == 1) {
				field[i] = setTo
				field[i+width] = setTo
				field[i-width] = setTo
				field[i-1+width] = setTo
			} else if (activePiece.rotation % 4 == 2) {
				field[i] = setTo
				field[i+1] = setTo
				field[i-1] = setTo
				field[i+1-width] = setTo
			} else if (activePiece.rotation % 4 == 3) {
				field[i] = setTo
				field[i+width] = setTo
				field[i-width] = setTo
				field[i+1-width] = setTo
			}
			break;
		case 'Z':
			if (activePiece.rotation % 2 == 0) {
				field[i] = setTo
				field[i-1] = setTo
				field[i+width] = setTo
				field[i+1+width] = setTo
			} else if (activePiece.rotation % 2 == 1) {
				field[i] = setTo
				field[i+width] = setTo
				field[i+1] = setTo
				field[i+1-width] = setTo
			}
			break;
		case 'S':
			if (activePiece.rotation % 2 == 0) {
				field[i] = setTo
				field[i+1] = setTo
				field[i-1+width] = setTo
				field[i+width] = setTo
			} else if (activePiece.rotation % 2 == 1) {
				field[i] = setTo
				field[i-width] = setTo
				field[i+1] = setTo
				field[i+1+width] = setTo
			}
			break;
		case 'I':
			if (activePiece.rotation % 2 == 0) {
				field[i] = setTo
				field[i+1] = setTo
				field[i-1] = setTo
				field[i-2] = setTo
			} else if (activePiece.rotation % 2 == 1) {
				field[i] = setTo
				field[i+width] = setTo
				field[i-width] = setTo
				field[i-2*width] = setTo
			}
			break;
		case 'T':
			if (activePiece.rotation % 4 == 0) {
				field[i] = setTo
				field[i+1] = setTo
				field[i-1] = setTo
				field[i+width] = setTo
			} else if (activePiece.rotation % 4 == 1) {
				field[i] = setTo
				field[i-1] = setTo
				field[i-width] = setTo
				field[i+width] = setTo
			} else if (activePiece.rotation % 4 == 2) {
				field[i] = setTo
				field[i+1] = setTo
				field[i-1] = setTo
				field[i-width] = setTo
			} else if (activePiece.rotation % 4 == 3) {
				field[i] = setTo
				field[i+1] = setTo
				field[i-width] = setTo
				field[i+width] = setTo
			}
			break;
		default:
	}
}

function keyPush(e) {
	switch(e.keyCode) {
		case 37:
			removePiece()
			activePiece.x -= 1
			if (!validPieceLocation()) {
				activePiece.x += 1
			}
			addPiece()
			break;
		case 38:
			removePiece()
			activePiece.rotation += 1
			if (!validPieceLocation()) {
				activePiece.rotation -= 1
			}
			addPiece()
			break;
		case 39:
			removePiece()
			activePiece.x += 1
			if (!validPieceLocation()) {
				activePiece.x -= 1
			}
			addPiece()
			break;
		case 40:
			removePiece()
			activePiece.y += 1
			if (!validPieceLocation()) {
				activePiece.y -= 1
			}
			addPiece()
			break;
	}
}


var pieces = [
	'O',
	'L',
	'J',
	'Z',
	'S',
	'I',
	'T',
]

function spawnPiece() {
	pieceId = pieces[Math.floor(Math.random() * pieces.length)]

	activePiece = {
		id: pieceId,
		rotation: 0,
		x: 5,
		y: 0,
		active: true,
	}
}
</script>
